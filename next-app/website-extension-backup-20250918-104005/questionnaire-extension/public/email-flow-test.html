<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; background: #0a0a0a; color: white; padding: 2rem; }
        .test { background: #1a1a1a; padding: 1rem; margin: 1rem 0; border-radius: 8px; }
        button { background: #3b82f6; color: white; border: none; padding: 1rem; border-radius: 4px; cursor: pointer; margin: 0.5rem; }
        .log { background: #000; padding: 1rem; margin: 1rem 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Email Flow Test</h1>
    
    <div class="test">
        <h3>Step 1: Simulate Email Collection</h3>
        <button onclick="simulateEmailCollection()">Store Email in localStorage</button>
    </div>
    
    <div class="test">
        <h3>Step 2: Simulate Results Generation</h3>
        <button onclick="simulateResultsGeneration()">Store Results in localStorage</button>
    </div>
    
    <div class="test">
        <h3>Step 3: Test Email Sending</h3>
        <button onclick="testEmailSending()">Send Email with Results</button>
    </div>
    
    <div class="test">
        <h3>Step 4: Complete Flow Test</h3>
        <button onclick="testCompleteFlow()">Test Complete Flow</button>
    </div>
    
    <div id="logs" class="log"></div>

    <script>
        function log(message) {
            const logs = document.getElementById('logs');
            logs.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        function simulateEmailCollection() {
            log('üìß Simulating email collection...');
            const testEmail = 'thearc@thearcme.com';
            localStorage.setItem('userEmail', testEmail);
            log('‚úÖ Email stored: ' + testEmail);
            
            // Also simulate saving to backend
            fetch('http://localhost:3001/api/save-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: testEmail,
                    timestamp: new Date().toISOString(),
                    consent: true,
                    source: 'questionnaire'
                })
            }).then(response => response.json())
            .then(data => {
                log('‚úÖ Email saved to backend: ' + JSON.stringify(data));
            }).catch(error => {
                log('‚ùå Backend save error: ' + error.message);
            });
        }

        function simulateResultsGeneration() {
            log('üìä Simulating results generation...');
            const sampleResults = {
                assessment_summary: "Based on your responses, we recommend the following health screenings.",
                urgent_tests: [
                    {
                        name: "Blood Pressure Test",
                        explanation: "Regular blood pressure monitoring is essential",
                        timeframe: "Within 1 week"
                    }
                ],
                categories: [
                    {
                        category_name: "Cardiovascular Health",
                        category_description: "Heart and blood vessel health screening",
                        tests: [
                            { name: "Cholesterol Test", description: "Complete lipid panel" },
                            { name: "ECG", description: "Electrocardiogram" }
                        ]
                    }
                ],
                next_steps: [
                    {
                        timeframe: "This week",
                        actions: ["Schedule blood pressure test", "Book cholesterol screening"]
                    }
                ]
            };
            
            localStorage.setItem('healthAssessmentResults', JSON.stringify(sampleResults));
            localStorage.setItem('cachedResults', JSON.stringify(sampleResults));
            log('‚úÖ Results stored in localStorage');
        }

        async function testEmailSending() {
            log('üìß Testing email sending...');
            
            try {
                const userEmail = localStorage.getItem('userEmail');
                const results = JSON.parse(localStorage.getItem('healthAssessmentResults') || '{}');
                
                if (!userEmail) {
                    log('‚ùå No user email found');
                    return;
                }
                
                if (!results || Object.keys(results).length === 0) {
                    log('‚ùå No results found');
                    return;
                }
                
                log('üìß Sending email to: ' + userEmail);
                log('üìß Results data: ' + JSON.stringify(results));
                
                const htmlContent = generateEmailHTML(results);
                const textContent = generateEmailText(results);
                
                const response = await fetch('http://localhost:3001/api/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: userEmail,
                        subject: 'Your Personalized Health Screening Plan - Right Screening Finder',
                        htmlContent: htmlContent,
                        textContent: textContent
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('‚ùå Email send failed: ' + errorText);
                    return;
                }
                
                const data = await response.json();
                log('‚úÖ Email sent successfully: ' + JSON.stringify(data));
                
            } catch (error) {
                log('‚ùå Email send error: ' + error.message);
            }
        }

        async function testCompleteFlow() {
            log('üîÑ Testing complete flow...');
            
            // Step 1: Store email
            localStorage.setItem('userEmail', 'thearc@thearcme.com');
            log('‚úÖ Step 1: Email stored');
            
            // Step 2: Store results
            const sampleResults = {
                assessment_summary: "Based on your responses, we recommend the following health screenings.",
                urgent_tests: [
                    {
                        name: "Blood Pressure Test",
                        explanation: "Regular blood pressure monitoring is essential",
                        timeframe: "Within 1 week"
                    }
                ],
                categories: [
                    {
                        category_name: "Cardiovascular Health",
                        category_description: "Heart and blood vessel health screening",
                        tests: [
                            { name: "Cholesterol Test", description: "Complete lipid panel" },
                            { name: "ECG", description: "Electrocardiogram" }
                        ]
                    }
                ],
                next_steps: [
                    {
                        timeframe: "This week",
                        actions: ["Schedule blood pressure test", "Book cholesterol screening"]
                    }
                ]
            };
            
            localStorage.setItem('healthAssessmentResults', JSON.stringify(sampleResults));
            log('‚úÖ Step 2: Results stored');
            
            // Step 3: Send email
            try {
                const userEmail = localStorage.getItem('userEmail');
                log('üìß Sending email to: ' + userEmail);
                
                const htmlContent = generateEmailHTML(sampleResults);
                const textContent = generateEmailText(sampleResults);
                
                const response = await fetch('http://localhost:3001/api/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: userEmail,
                        subject: 'Your Personalized Health Screening Plan - Right Screening Finder',
                        htmlContent: htmlContent,
                        textContent: textContent
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('‚ùå Email send failed: ' + errorText);
                    return;
                }
                
                const data = await response.json();
                log('‚úÖ Step 3: Email sent successfully: ' + JSON.stringify(data));
                log('üéØ Complete flow test successful!');
                
            } catch (error) {
                log('‚ùå Complete flow error: ' + error.message);
            }
        }

        function generateEmailHTML(results) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Your Health Screening Plan</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                        .header { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                        .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
                        .section { margin-bottom: 25px; }
                        .section h3 { color: #3b82f6; margin-bottom: 15px; }
                        .test-item { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #3b82f6; }
                        .urgent { border-left-color: #ef4444; }
                        .footer { text-align: center; margin-top: 30px; padding: 20px; color: #666; font-size: 14px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Your Personalized Health Screening Plan</h1>
                            <p>Based on your health assessment responses</p>
                        </div>
                        <div class="content">
                            <div class="section">
                                <h3>Assessment Summary</h3>
                                <p>${results.assessment_summary || 'Your personalized health screening plan has been generated based on your responses.'}</p>
                            </div>
                            
                            ${results.urgent_tests ? `
                            <div class="section">
                                <h3>Urgent Tests</h3>
                                ${results.urgent_tests.map(test => `
                                    <div class="test-item urgent">
                                        <strong>${test.name}</strong><br>
                                        ${test.explanation}<br>
                                        <em>Timeframe: ${test.timeframe}</em>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            ${results.categories ? `
                            <div class="section">
                                <h3>Health Categories</h3>
                                ${results.categories.map(category => `
                                    <div class="test-item">
                                        <strong>${category.category_name}</strong><br>
                                        ${category.category_description}<br>
                                        <ul>
                                            ${category.tests.map(test => `<li>${test.name} - ${test.description}</li>`).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            ${results.next_steps ? `
                            <div class="section">
                                <h3>Next Steps</h3>
                                ${results.next_steps.map(step => `
                                    <div class="test-item">
                                        <strong>${step.timeframe}</strong><br>
                                        <ul>
                                            ${step.actions.map(action => `<li>${action}</li>`).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                        <div class="footer">
                            <p>This email was generated by Right Screening Finder</p>
                            <p>For questions, contact us at thearc@thearcme.com</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        function generateEmailText(results) {
            return `
                Your Personalized Health Screening Plan
                
                Assessment Summary:
                ${results.assessment_summary || 'Your personalized health screening plan has been generated based on your responses.'}
                
                ${results.urgent_tests ? `
                Urgent Tests:
                ${results.urgent_tests.map(test => `- ${test.name}: ${test.explanation} (${test.timeframe})`).join('\n')}
                ` : ''}
                
                ${results.categories ? `
                Health Categories:
                ${results.categories.map(category => `
                ${category.category_name}:
                ${category.category_description}
                Tests: ${category.tests.map(test => test.name).join(', ')}
                `).join('\n')}
                ` : ''}
                
                ${results.next_steps ? `
                Next Steps:
                ${results.next_steps.map(step => `
                ${step.timeframe}:
                ${step.actions.map(action => `- ${action}`).join('\n')}
                `).join('\n')}
                ` : ''}
                
                ---
                This email was generated by Right Screening Finder
                For questions, contact us at thearc@thearcme.com
            `;
        }

        // Initialize
        log('üîß Email Flow Test Page Loaded');
        log('üìß Backend URL: http://localhost:3001');
        log('üåê Frontend URL: http://localhost:8086');
    </script>
</body>
</html>
