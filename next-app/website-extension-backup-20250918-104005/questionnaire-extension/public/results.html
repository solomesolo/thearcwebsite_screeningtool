<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Personalized Screening Plan - Right Screening Finder</title>
    
    <!-- Simple PDF Generation without external libraries -->
    <script>
        // Simple PDF generation using browser's print functionality
        function generateSimplePDF() {
            console.log('🔄 Generating PDF using browser print...');
            
            // Create a new window with the content
            const printWindow = window.open('', '_blank');
            const container = document.querySelector('.container');
            
            if (!container) {
                alert('Error: Content not found');
                return;
            }
            
            // Get the content HTML
            const content = container.innerHTML;
            
            // Create the print document
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>My Screening Plan - Right Screening Finder</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            line-height: 1.6;
                            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
                            color: #ffffff;
                            max-width: 1200px;
                            margin: 0 auto;
                            padding: 2rem;
                            min-height: 100vh;
                        }
                        .header-card {
                            background: rgba(26, 26, 26, 0.95);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 16px;
                            padding: 2rem;
                            margin-bottom: 2rem;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        }
                        .header-title {
                            font-size: 2.5rem;
                            font-weight: 700;
                            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                            margin-bottom: 1rem;
                        }
                        .header-subtitle {
                            color: #cbd5e1;
                            font-size: 1.1rem;
                        }
                        .summary-card {
                            background: rgba(26, 26, 26, 0.95);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 16px;
                            padding: 2rem;
                            margin-bottom: 2rem;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        }
                        .summary-title {
                            font-size: 1.8rem;
                            font-weight: 600;
                            color: #ffffff;
                            margin-bottom: 1rem;
                        }
                        .summary-text {
                            font-size: 1rem;
                            color: #cbd5e1;
                            line-height: 1.6;
                        }
                        .urgent-section {
                            background: rgba(26, 26, 26, 0.95);
                            border: 1px solid rgba(239, 68, 68, 0.3);
                            border-radius: 16px;
                            padding: 2rem;
                            margin-bottom: 2rem;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                            position: relative;
                        }
                        .urgent-section::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(220, 38, 38, 0.05) 100%);
                            border-radius: 16px;
                            z-index: -1;
                        }
                        .urgent-title {
                            font-size: 1.8rem;
                            font-weight: 600;
                            color: #ef4444;
                            margin-bottom: 1rem;
                        }
                        .urgent-test {
                            background: rgba(239, 68, 68, 0.1);
                            border: 1px solid rgba(239, 68, 68, 0.3);
                            border-radius: 12px;
                            padding: 1.5rem;
                            margin-bottom: 1rem;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .test-name {
                            font-weight: 600;
                            color: #ef4444;
                            font-size: 1.1rem;
                        }
                        .test-status {
                            color: #cbd5e1;
                            font-size: 0.9rem;
                            background: rgba(239, 68, 68, 0.2);
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                        }
                        .categories-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                            gap: 3rem;
                            margin-top: 3rem;
                        }
                        .category-card {
                            background: rgba(26, 26, 26, 0.95);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 16px;
                            padding: 2rem;
                            margin-bottom: 2rem;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        }
                        .category-title {
                            font-size: 1.5rem;
                            font-weight: 600;
                            color: #3b82f6;
                            margin-bottom: 1rem;
                        }
                        .category-item {
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 12px;
                            padding: 1.5rem;
                            margin-bottom: 1rem;
                            text-align: center;
                        }
                        .category-icon {
                            font-size: 3rem;
                            margin-bottom: 1rem;
                            display: block;
                        }
                        .category-title {
                            font-size: 1.5rem;
                            font-weight: 700;
                            color: #ffffff;
                            margin-bottom: 1rem;
                        }
                        .category-description {
                            color: #cbd5e1;
                            margin-bottom: 1.5rem;
                            line-height: 1.6;
                        }
                        .category-features {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 0.5rem;
                            justify-content: center;
                            margin-bottom: 1rem;
                        }
                        .feature-tag {
                            background: rgba(99, 102, 241, 0.1);
                            color: #a78bfa;
                            padding: 0.25rem 0.75rem;
                            border-radius: 12px;
                            font-size: 0.875rem;
                            font-weight: 500;
                        }
                        .category-count {
                            color: #94a3b8;
                            font-size: 0.875rem;
                            font-weight: 500;
                        }
                        .next-steps {
                            background: rgba(26, 26, 26, 0.95);
                            border: 1px solid rgba(59, 130, 246, 0.3);
                            border-radius: 16px;
                            padding: 2rem;
                            margin-top: 2rem;
                            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        }
                        .next-steps-title {
                            font-size: 1.8rem;
                            font-weight: 600;
                            color: #3b82f6;
                            margin-bottom: 1.5rem;
                        }
                        .step-item {
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            border-radius: 12px;
                            padding: 1.5rem;
                            margin-bottom: 1rem;
                        }
                        .step-title {
                            font-weight: 600;
                            color: #ffffff;
                            margin-bottom: 0.5rem;
                            font-size: 1.1rem;
                        }
                        .step-description {
                            color: #cbd5e1;
                            font-size: 0.95rem;
                            line-height: 1.6;
                        }
                        .timeframe-header {
                            display: flex;
                            align-items: center;
                            margin-bottom: 1rem;
                        }
                        .timeframe-label {
                            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                            color: white;
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            font-size: 0.875rem;
                            font-weight: 600;
                        }
                        .timeframe-line {
                            height: 2px;
                            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
                            flex: 1;
                            margin-right: 1rem;
                        }
                        .timeframe-line.urgent {
                            background: linear-gradient(90deg, #ef4444, #dc2626);
                        }
                        .timeframe-line.soon {
                            background: linear-gradient(90deg, #f59e0b, #d97706);
                        }
                        .timeframe-line.later {
                            background: linear-gradient(90deg, #10b981, #059669);
                        }
                        @media print {
                            body { 
                                margin: 0; 
                                padding: 15px; 
                                background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%) !important;
                                color: #ffffff !important;
                            }
                            .header-card, .summary-card, .urgent-section, .category-card, .next-steps {
                                break-inside: avoid;
                                background: rgba(26, 26, 26, 0.95) !important;
                                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div style="text-align: center; margin-bottom: 40px; padding: 30px; background: rgba(26, 26, 26, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);">
                        <h1 style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0; font-size: 32px; font-weight: 700;">Right Screening Finder</h1>
                        <p style="color: #cbd5e1; margin: 10px 0 0 0; font-size: 18px; font-weight: 500;">Personalized Health Screening Plan</p>
                        <p style="color: #94a3b8; margin: 15px 0 0 0; font-size: 14px;">Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
                    ${content}
                    <div style="margin-top: 40px; padding: 30px; background: rgba(26, 26, 26, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; text-align: center; color: #94a3b8; font-size: 12px;">
                        <p style="margin: 0 0 10px 0; color: #cbd5e1; font-weight: 500;">Generated by Right Screening Finder • ${new Date().toLocaleDateString()}</p>
                        <p style="margin: 0; color: #94a3b8;">This report is for informational purposes only and should not replace professional medical advice.</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load, then trigger print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            console.log('✅ PDF generation initiated');
        }
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            background-color: #0a0a0a !important;
            background-image: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%) !important;
            color: #ffffff !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            color-scheme: dark !important;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Header Section */
        .header-card {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        
        .header-subtitle {
            font-size: 1.1rem;
            color: #cbd5e1;
        }
        
        /* Assessment Summary */
        .summary-card {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .summary-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1rem;
        }
        
        .summary-text {
            font-size: 1rem;
            color: #cbd5e1;
            line-height: 1.6;
        }
        
        /* Urgent Tests Section */
        .urgent-section {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .urgent-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(220, 38, 38, 0.05) 100%);
            border-radius: 16px;
            z-index: -1;
        }
        
        .urgent-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ef4444;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
        }
        
        .urgent-test {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .test-info {
            flex: 1;
        }
        
        .test-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }
        
        .test-description {
            font-size: 0.95rem;
            color: #cbd5e1;
            margin-bottom: 0.5rem;
        }
        
        .test-timeframe {
            font-size: 0.9rem;
            color: #f87171;
            font-weight: 500;
        }
        
        .test-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 1rem;
        }
        
        .status-recommended {
            background-color: #1e40af;
            color: #ffffff;
        }
        
        .status-never-done {
            background-color: #dc2626;
            color: #ffffff;
        }
        
        /* Categories Grid */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .category-card {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .category-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.8rem;
            transition: all 0.3s ease;
        }
        
        .category-icon:hover {
            transform: scale(1.1);
        }
        
        .icon-cardiovascular { }
        .icon-metabolic { }
        .icon-hormonal { }
        .icon-nutritional { }
        .icon-longevity { }
        .icon-gut { }
        
        .category-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .category-description {
            font-size: 0.9rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .category-test {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .test-title {
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .status-due-soon {
            background-color: #f59e0b;
            color: #ffffff;
        }
        
        .test-explanation {
            font-size: 0.85rem;
            color: #cbd5e1;
            line-height: 1.4;
        }
        
        /* Next Steps Section */
        .next-steps {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .next-steps-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1.5rem;
        }
        
        .timeframe-section {
            margin-bottom: 1.5rem;
        }
        
        .timeframe-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .timeframe-line {
            width: 4px;
            height: 40px;
            border-radius: 2px;
            margin-right: 1rem;
        }
        
        .line-urgent { background-color: #ef4444; }
        .line-medium { background-color: #10b981; }
        
        .timeframe-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }
        
        .timeframe-actions {
            margin-left: 2rem;
        }
        
        .action-item {
            font-size: 0.95rem;
            color: #cbd5e1;
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .action-item::before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #3b82f6;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        /* Download Button */
        .download-section {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: #ffffff;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);
        }
        
        .download-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .new-assessment-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #ffffff;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
            margin-left: 1rem;
        }
        
        .new-assessment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4);
        }
        
        /* Motivational Quote */
        .quote-section {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .quote-text {
            font-size: 1.1rem;
            font-style: italic;
            color: #ffffff;
            line-height: 1.6;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header-title {
                font-size: 2rem;
            }
            
            .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .urgent-test {
                flex-direction: column;
            }
            
            .test-status {
                margin-left: 0;
                margin-top: 1rem;
                align-self: flex-start;
            }
        }
        
        /* PDF Export Styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            
            .container {
                max-width: none !important;
                margin: 0 !important;
                padding: 20px !important;
            }
            
            .header-card, .summary-card, .urgent-section, .category-card {
                background: white !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Card -->
        <div class="header-card">
            <h1 class="header-title">Your Personalized Screening Plan</h1>
            <p class="header-subtitle">These are the tests that matter most for your prevention and longevity journey.</p>
        </div>
        
        <!-- Assessment Summary -->
        <div class="summary-card">
            <h2 class="summary-title">ASSESSMENT SUMMARY</h2>
            <p class="summary-text" id="assessmentSummary">
                Based on your age, family history of diabetes, and lifestyle factors, there are several areas of concern. Your frequent fatigue, skin changes, and borderline magnesium/zinc levels suggest potential nutritional deficiencies. Abnormal electrolyte and bio-aging results, along with an outdated microbiome assessment, indicate potential metabolic and gut health issues. Your plant-based diet and moderate alcohol consumption are generally positive, but specific tests are needed to ensure optimal health.
            </p>
        </div>
        
        <!-- Urgent Tests Section -->
        <div class="urgent-section">
            <h2 class="urgent-title">URGENT TESTS (TOP PRIORITY)</h2>
            <div id="urgentTests">
                <!-- Urgent tests will be populated here -->
            </div>
        </div>
        
        <!-- Categories Grid -->
        <div class="categories-grid" id="categoriesGrid">
            <!-- Categories will be populated here -->
        </div>
        
        <!-- Next Steps -->
        <div class="next-steps">
            <h2 class="next-steps-title">NEXT STEPS</h2>
            <div id="nextSteps">
                <!-- Next steps will be populated here -->
            </div>
        </div>
        
        <!-- Download Button -->
        <div class="download-section">
            <button class="download-btn" onclick="downloadPlan()">DOWNLOAD YOUR SCREENING PLAN</button>
            <button class="new-assessment-btn" onclick="startNewAssessment()">START NEW ASSESSMENT</button>
        </div>
        
        <!-- Motivational Quote -->
        <div class="quote-section">
            <p class="quote-text">
                "By completing these screenings, you're building the foundation for a longer, healthier life. Each test brings you closer to understanding your body's unique needs and optimizing your healthspan."
            </p>
        </div>
    </div>

    <script>
        // Force dark background
        document.documentElement.style.backgroundColor = '#0a0a0a';
        document.body.style.backgroundColor = '#0a0a0a';
        
        // Check if we have cached results from loading page
        const cachedResults = localStorage.getItem('healthAssessmentResults');
        const questionnaireData = localStorage.getItem('questionnaireData');
        console.log('📋 Checking for cached results:', cachedResults);
        console.log('📋 Checking for questionnaire data:', questionnaireData);
        
        // Debug: Show what's actually in localStorage
        console.log('🔍 All localStorage keys:', Object.keys(localStorage));
        console.log('🔍 healthAssessmentResults length:', cachedResults ? cachedResults.length : 'null');
        console.log('🔍 questionnaireData length:', questionnaireData ? questionnaireData.length : 'null');
        
        if (cachedResults) {
            console.log('✅ Using cached results from loading page');
            const data = JSON.parse(cachedResults);
            console.log('🔍 Parsed data:', data);
            console.log('🔍 Data type:', typeof data);
            console.log('🔍 Data keys:', Object.keys(data));
            displayResults(data);
        } else if (questionnaireData) {
            console.log('❌ No cached results, but have questionnaire data - redirecting to loading page');
            window.location.href = '/loading.html';
        } else {
            console.log('❌ No data found, using test data for debugging');
            // Test data to verify display functions work
            const testData = {
                assessment_summary: "Test assessment summary for debugging purposes.",
                urgent_tests: [
                    {
                        name: "Test HbA1c",
                        explanation: "Test explanation for HbA1c test",
                        timeframe: "Within 2 weeks",
                        status: "NEVER DONE"
                    }
                ],
                categories: [
                    {
                        category_name: "Test Category",
                        category_description: "Test category description",
                        tests: [
                            {
                                name: "Test Lipid Panel",
                                description: "Test lipid panel description",
                                status: "MISSING"
                            }
                        ]
                    }
                ],
                next_steps: [
                    {
                        timeframe: "URGENT (within 2 weeks)",
                        actions: ["Test action 1", "Test action 2"]
                    }
                ]
            };
            console.log('🧪 Using test data:', testData);
            displayResults(testData);
        }
        
        // Function to send results via email
        async function sendResultsEmail(results) {
            try {
                console.log('📧 sendResultsEmail called with:', results);
                
                // Get the user's email from localStorage
                const userEmail = localStorage.getItem('userEmail');
                console.log('📧 Retrieved userEmail from localStorage:', userEmail);
                
                if (!userEmail) {
                    console.log('📧 No user email found, prompting for email');
                    const email = prompt('Please enter your email address to receive your personalized health screening plan:');
                    if (email && email.includes('@')) {
                        localStorage.setItem('userEmail', email);
                        console.log('📧 Email collected and stored:', email);
                        // Retry sending email
                        return sendResultsEmail(results);
                    } else {
                        console.log('📧 Invalid email or user cancelled, skipping email send');
                        return;
                    }
                }
                
                console.log('📧 Sending results via email to:', userEmail);
                
                // Generate HTML email content
                console.log('📧 Generating email content for results:', results);
                const htmlContent = generateEmailHTML(results);
                const textContent = generateEmailText(results);
                console.log('📧 Generated HTML content length:', htmlContent.length);
                console.log('📧 Generated text content length:', textContent.length);
                
                const emailResponse = await fetch('https://backend-8p7kgqsn9-annas-projects-3d23b0f3.vercel.app/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: userEmail,
                        subject: 'Your Personalized Health Screening Plan - Right Screening Finder',
                        htmlContent: htmlContent,
                        textContent: textContent
                    })
                });
                
                if (!emailResponse.ok) {
                    const errorText = await emailResponse.text();
                    console.error('📧 Email send error:', errorText);
                    throw new Error(`Failed to send email: ${errorText}`);
                }
                
                const emailData = await emailResponse.json();
                console.log('📧 Email sent successfully:', emailData);
                
            } catch (error) {
                console.error('📧 Error sending email:', error);
                // Don't show error to user - email sending is optional
                console.log('📧 Continuing without email...');
            }
        }
        
        // Function to generate HTML email content
        function generateEmailHTML(results) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Your Health Screening Plan</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                        .header { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                        .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
                        .section { margin-bottom: 25px; }
                        .section h3 { color: #3b82f6; margin-bottom: 15px; }
                        .test-item { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #3b82f6; }
                        .urgent { border-left-color: #ef4444; }
                        .footer { text-align: center; margin-top: 30px; padding: 20px; color: #666; font-size: 14px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Your Personalized Health Screening Plan</h1>
                            <p>Based on your health assessment responses</p>
                        </div>
                        <div class="content">
                            <div class="section">
                                <h3>Assessment Summary</h3>
                                <p>${results.assessment_summary || results.assessmentSummary || 'Your personalized health screening plan has been generated based on your responses.'}</p>
                            </div>
                            
                            ${results.urgent_tests || results.urgentTests ? `
                            <div class="section">
                                <h3>Urgent Tests</h3>
                                ${(results.urgent_tests || results.urgentTests).map(test => `
                                    <div class="test-item urgent">
                                        <strong>${test.name}</strong><br>
                                        ${test.explanation}<br>
                                        <em>Timeframe: ${test.timeframe}</em>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            ${results.categories ? `
                            <div class="section">
                                <h3>Health Categories</h3>
                                ${results.categories.map(category => `
                                    <div class="test-item">
                                        <strong>${category.category_name}</strong><br>
                                        ${category.category_description}<br>
                                        <ul>
                                            ${category.tests.map(test => `<li>${test.name} - ${test.description}</li>`).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            ${results.next_steps || results.nextSteps ? `
                            <div class="section">
                                <h3>Next Steps</h3>
                                ${(results.next_steps || results.nextSteps).map(step => `
                                    <div class="test-item">
                                        <strong>${step.timeframe}</strong><br>
                                        <ul>
                                            ${step.actions.map(action => `<li>${action}</li>`).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                        <div class="footer">
                            <p>This email was generated by Right Screening Finder</p>
                            <p>For questions, contact us at thearc@thearcme.com</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
        }
        
        // Function to generate text email content
        function generateEmailText(results) {
            return `
                Your Personalized Health Screening Plan
                
                Assessment Summary:
                ${results.assessment_summary || results.assessmentSummary || 'Your personalized health screening plan has been generated based on your responses.'}
                
                ${results.urgent_tests || results.urgentTests ? `
                Urgent Tests:
                ${(results.urgent_tests || results.urgentTests).map(test => `- ${test.name}: ${test.explanation} (${test.timeframe})`).join('\n')}
                ` : ''}
                
                ${results.categories ? `
                Health Categories:
                ${results.categories.map(category => `
                ${category.category_name}:
                ${category.category_description}
                Tests: ${category.tests.map(test => test.name).join(', ')}
                `).join('\n')}
                ` : ''}
                
                ${results.next_steps || results.nextSteps ? `
                Next Steps:
                ${(results.next_steps || results.nextSteps).map(step => `
                ${step.timeframe}:
                ${step.actions.map(action => `- ${action}`).join('\n')}
                `).join('\n')}
                ` : ''}
                
                ---
                This email was generated by Right Screening Finder
                For questions, contact us at thearc@thearcme.com
            `;
        }
        
        // Function to display results from API response
        function displayResults(data) {
            console.log('🎯 Displaying results:', data);
            console.log('🎯 Data keys:', Object.keys(data));
            
            // Handle API response structure - data might be wrapped in 'data' field
            let actualData = data;
            if (data.data) {
                actualData = data.data;
                console.log('🎯 Using wrapped data:', actualData);
            } else if (data.fallbackData) {
                actualData = data.fallbackData;
                console.log('🎯 Using fallback data:', actualData);
            }
            
            // Email is now sent automatically by the backend during API processing
            console.log('📧 Email sending is handled by backend during API call');
            
            console.log('🎯 Urgent tests:', actualData.urgentTests || actualData.urgent_tests);
            console.log('🎯 Categories:', actualData.categories);
            console.log('🎯 Next steps:', actualData.nextSteps || actualData.next_steps);
            
            // Update assessment summary
            if (actualData.assessmentSummary || actualData.assessment_summary) {
                document.getElementById('assessmentSummary').innerHTML = actualData.assessmentSummary || actualData.assessment_summary;
                console.log('✅ Assessment summary updated');
            } else {
                console.error('❌ No assessment summary found');
            }
            
            // Update urgent tests
            const urgentTests = actualData.urgentTests || actualData.urgent_tests;
            if (urgentTests && Array.isArray(urgentTests)) {
                console.log('🎯 Calling displayUrgentTests with:', urgentTests);
                displayUrgentTests(urgentTests);
            } else {
                console.error('❌ No urgent tests data found or not an array:', urgentTests);
            }
            
            // Update categories
            if (actualData.categories && Array.isArray(actualData.categories)) {
                console.log('🎯 Calling displayCategoriesFromAPI with:', actualData.categories);
                console.log('🎯 Number of categories:', actualData.categories.length);
                console.log('🎯 Category names:', actualData.categories.map(c => c.category_name));
                displayCategoriesFromAPI(actualData.categories);
            } else {
                console.error('❌ No categories data found or not an array:', actualData.categories);
            }
            
            // Update next steps
            const nextSteps = actualData.nextSteps || actualData.next_steps;
            if (nextSteps && Array.isArray(nextSteps)) {
                console.log('🎯 Calling displayNextSteps with:', nextSteps);
                displayNextSteps(nextSteps);
            } else {
                console.error('❌ No next steps data found or not an array:', nextSteps);
            }
        }
        
        // Function to get hardcoded data as fallback
        function getHardcodedData() {
            return {
                assessmentSummary: "Based on your age, family history of diabetes, and lifestyle factors, there are several areas of concern. Your frequent fatigue, skin changes, and borderline magnesium/zinc levels suggest potential nutritional deficiencies. Abnormal electrolyte and bio-aging results, along with an outdated microbiome assessment, indicate potential metabolic and gut health issues. Your plant-based diet and moderate alcohol consumption are generally positive, but specific tests are needed to ensure optimal health.",
                urgentTests: [
                    {
                        name: "HbA1c (3-month average blood sugar)",
                        explanation: "Given your family history of diabetes, it's critical to assess your current blood sugar control.",
                        timeframe: "Schedule within 1-2 weeks",
                        status: "RECOMMENDED"
                    },
                    {
                        name: "Omega-3 Index",
                        explanation: "You've never had this test, and it's important to ensure adequate omega-3 intake on a plant-based diet.",
                        timeframe: "Schedule within 1-2 weeks",
                        status: "NEVER DONE"
                    }
                ],
                categories: [
                    {
                        category_name: "Cardiovascular Health",
                        category_description: "Heart disease is the leading cause of death worldwide, and early detection of risk factors is key.",
                        tests: [
                            { 
                                name: "Lipid Panel", 
                                description: "This test measures cholesterol levels, which can indicate cardiovascular risk. It's especially important due to your family history of diabetes.", 
                                status: "DUE SOON" 
                            }
                        ]
                    },
                    {
                        category_name: "Metabolic Health",
                        category_description: "Metabolic health is crucial for energy, weight management, and preventing chronic diseases.",
                        tests: [
                            { 
                                name: "Comprehensive Metabolic Panel", 
                                description: "Your previous abnormal electrolyte results and frequent fatigue warrant a comprehensive metabolic assessment.", 
                                status: "DUE SOON" 
                            }
                        ]
                    },
                    {
                        category_name: "Hormonal Health",
                        category_description: "Hormones regulate many body functions, and imbalances can cause various symptoms.",
                        tests: [
                            { 
                                name: "Thyroid Function Tests", 
                                description: "Your fatigue and skin changes could be symptoms of thyroid dysfunction.", 
                                status: "RECOMMENDED" 
                            }
                        ]
                    },
                    {
                        category_name: "Nutritional Status",
                        category_description: "Nutrient deficiencies can cause a range of health problems and are often overlooked.",
                        tests: [
                            { 
                                name: "Magnesium and Zinc Levels", 
                                description: "Your borderline results and plant-based diet make it important to monitor these essential minerals.", 
                                status: "DUE SOON" 
                            }
                        ]
                    },
                    {
                        category_name: "Longevity Biomarkers",
                        category_description: "These tests can provide insights into your biological age and potential longevity.",
                        tests: [
                            { 
                                name: "Advanced Bio-aging Panel", 
                                description: "Your previous abnormal bio-aging results need follow-up to assess your biological age.", 
                                status: "RECOMMENDED" 
                            }
                        ]
                    },
                    {
                        category_name: "Gut Health",
                        category_description: "Gut health affects overall wellness, immunity, and even mental health.",
                        tests: [
                            { 
                                name: "Comprehensive Microbiome Analysis", 
                                description: "Your outdated microbiome assessment needs updating to understand your current gut health status.", 
                                status: "DUE SOON" 
                            }
                        ]
                    }
                ],
                nextSteps: [
                    { action: "Schedule your HbA1c test within the next 1-2 weeks" },
                    { action: "Book your Omega-3 Index test to assess your fatty acid status" },
                    { action: "Consider a comprehensive metabolic panel to address your fatigue concerns" },
                    { action: "Update your microbiome assessment to get current gut health insights" }
                ]
            };
        }
        
        // Function to display categories from API response
        function displayCategoriesFromAPI(categories) {
            const categoriesContainer = document.getElementById('categoriesGrid');
            categoriesContainer.innerHTML = '';
            
            const iconMap = {
                'Cardiovascular Health': { icon: '❤️', class: 'icon-cardiovascular' },
                'Metabolic Health': { icon: '⚡', class: 'icon-metabolic' },
                'Hormonal Health': { icon: '⚖️', class: 'icon-hormonal' },
                'Nutritional Status': { icon: '🌿', class: 'icon-nutritional' },
                'Longevity Biomarkers': { icon: '🧬', class: 'icon-longevity' },
                'Gut Health': { icon: '🎯', class: 'icon-gut' }
            };
            
            categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category-card';
                
                const iconInfo = iconMap[category.category_name] || { icon: '📊', class: 'icon-metabolic' };
                
                let testsHtml = '';
                if (category.tests && category.tests.length > 0) {
                    testsHtml = category.tests.map(test => {
                        const statusClass = test.status === 'RECOMMENDED' ? 'status-recommended' : 'status-due-soon';
                        return `
                            <div class="category-test">
                                <div class="test-header">
                                    <div class="test-title">${test.name}</div>
                                    <div class="test-status ${statusClass}">${test.status}</div>
                                </div>
                                <div class="test-explanation">${test.description}</div>
                            </div>
                        `;
                    }).join('');
                }
                
                categoryElement.innerHTML = `
                    <div class="category-header">
                        <div class="category-icon ${iconInfo.class}">${iconInfo.icon}</div>
                        <div class="category-info">
                            <h3 class="category-title">${category.category_name}</h3>
                            <p class="category-description">${category.category_description}</p>
                        </div>
                    </div>
                    <div class="category-tests">
                        ${testsHtml}
                    </div>
                `;
                
                categoriesContainer.appendChild(categoryElement);
            });
        }
        
        // Function to display next steps from API response
        function displayNextSteps(nextSteps) {
            const nextStepsContainer = document.getElementById('nextSteps');
            nextStepsContainer.innerHTML = '';
            
            nextSteps.forEach(step => {
                const stepElement = document.createElement('div');
                stepElement.className = 'next-step';
                stepElement.innerHTML = `
                    <div class="step-icon">✓</div>
                    <div class="step-text">${step.action}</div>
                `;
                nextStepsContainer.appendChild(stepElement);
            });
        }
        
        function displayUrgentTests(urgentTests) {
            console.log('🚨 displayUrgentTests called with:', urgentTests);
            const urgentContainer = document.getElementById('urgentTests');
            console.log('🚨 Urgent container element:', urgentContainer);
            urgentContainer.innerHTML = '';
            
            if (!urgentTests || !Array.isArray(urgentTests)) {
                console.error('❌ No urgent tests data provided or not an array:', urgentTests);
                return;
            }
            
            console.log('✅ Processing urgent tests:', urgentTests.length, 'items');
            
            urgentTests.forEach(test => {
                const testElement = document.createElement('div');
                testElement.className = 'urgent-test';
                
                const statusClass = test.status === 'RECOMMENDED' ? 'status-recommended' : 'status-never-done';
                
                testElement.innerHTML = `
                    <div class="test-info">
                        <div class="test-name">${test.name}</div>
                        <div class="test-description">${test.explanation}</div>
                        <div class="test-timeframe">Timeframe: ${test.timeframe}</div>
                    </div>
                    <div class="test-status ${statusClass}">${test.status}</div>
                `;
                
                urgentContainer.appendChild(testElement);
            });
        }
        
        function displayNextSteps(nextSteps) {
            console.log('🚨 displayNextSteps called with:', nextSteps);
            const nextStepsContainer = document.getElementById('nextSteps');
            console.log('🚨 Next steps container element:', nextStepsContainer);
            nextStepsContainer.innerHTML = '';
            
            if (!nextSteps || !Array.isArray(nextSteps)) {
                console.error('❌ No next steps data provided or not an array:', nextSteps);
                return;
            }
            
            console.log('✅ Processing next steps:', nextSteps.length, 'items');
            
            nextSteps.forEach(step => {
                const stepElement = document.createElement('div');
                stepElement.className = 'timeframe-section';
                
                const isUrgent = step.timeframe.toLowerCase().includes('urgent');
                const lineClass = isUrgent ? 'line-urgent' : 'line-medium';
                
                const actionsHtml = step.actions.map(action => 
                    `<div class="action-item">${action}</div>`
                ).join('');
                
                stepElement.innerHTML = `
                    <div class="timeframe-header">
                        <div class="timeframe-line ${lineClass}"></div>
                        <div class="timeframe-label">${step.timeframe}</div>
                    </div>
                    <div class="timeframe-actions">
                        ${actionsHtml}
                    </div>
                `;
                
                nextStepsContainer.appendChild(stepElement);
            });
        }
        
        function startNewAssessment() {
            console.log('🔄 Starting new assessment...');
            
            // Clear all localStorage data
            localStorage.removeItem('questionnaireData');
            localStorage.removeItem('healthAssessmentResults');
            localStorage.removeItem('cachedResults');
            
            console.log('✅ All data cleared - redirecting to questionnaire');
            
            // Redirect to questionnaire
            window.location.href = '/questionnaire.html';
        }
        
        
        function downloadPlan() {
            console.log('🔄 Starting PDF generation...');
            
            // Show loading state
            const downloadBtn = document.querySelector('.download-btn');
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = 'GENERATING PDF...';
            downloadBtn.disabled = true;
            
            try {
                // Use the simple PDF generation method
                generateSimplePDF();
                
                // Reset button state after a short delay
                setTimeout(() => {
                    downloadBtn.textContent = originalText;
                    downloadBtn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error generating PDF:', error);
                alert('PDF generation failed. Please try again.');
                
                // Reset button state
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        }
        
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ PDF generation ready (using browser print functionality)');
        });
    </script>
    
    <!-- Mock API for testing without backend -->
    <script src="mock-api.js"></script>
</body>
</html>
