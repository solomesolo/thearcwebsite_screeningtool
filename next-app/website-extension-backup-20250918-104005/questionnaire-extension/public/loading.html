<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decoding Your Health Blueprint - Right Screening Finder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            background-color: #0a0a0a !important;
            background-image: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%) !important;
            color: #ffffff !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color-scheme: dark !important;
        }
        
        .loading-container {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
        }
        
        .loading-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .loading-subtitle {
            font-size: 1.2rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
        }
        
        .loading-note {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 3rem;
            font-style: italic;
        }
        
        .progress-container {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 4s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transition: width 1s ease;
            width: 0%;
        }
        
        .progress-text {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .loading-facts {
            background-color: rgba(26, 26, 26, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .fact-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1rem;
        }
        
        .fact-content {
            font-size: 1rem;
            color: #cbd5e1;
            line-height: 1.6;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="loading-container">
        <div class="loading-header">
            <h1>Decoding Your Health Blueprint</h1>
            <p class="loading-subtitle">Analyzing your responses to create a personalized screening plan...</p>
            <p class="loading-note">⏱️ This process typically takes 60-90 seconds to ensure accurate results</p>
        </div>
        
        <div class="progress-container">
            <div class="spinner"></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Initializing analysis...</div>
        </div>
        
        <div class="loading-facts">
            <h3 class="fact-title">Did You Know?</h3>
            <div class="fact-content" id="factContent">
                Loading interesting health facts...
            </div>
        </div>
    </div>

    <script>
        // Force dark background
        document.documentElement.style.backgroundColor = '#0a0a0a';
        document.body.style.backgroundColor = '#0a0a0a';
        
        const facts = [
            "70% of chronic diseases can be prevented with early detection through proper screening.",
            "Many health conditions show no symptoms until they reach advanced stages.",
            "Regular health screenings can detect issues 5-10 years before symptoms appear.",
            "Personalized screening plans are more effective than one-size-fits-all approaches.",
            "Early detection can reduce treatment costs by up to 80%.",
            "Your genetic makeup influences which screenings are most important for you.",
            "Lifestyle factors like diet and exercise affect your screening needs.",
            "Age-appropriate screenings can extend your healthy lifespan by years.",
            "Family history plays a crucial role in determining your screening priorities.",
            "Preventive care is 10 times more cost-effective than treatment."
        ];
        
        let currentFactIndex = 0;
        let progress = 0;
        let progressInterval;
        let factInterval;
        let startTime = Date.now();
        let estimatedDuration = 90000; // 90 seconds estimated (60-90 seconds range)
        let apiCallStarted = false;
        let apiCallCompleted = false;
        let currentProgress = 0;
        let progressTarget = 0;
        let lastProgressUpdate = Date.now();
        let progressStage = 0;
        
        // Completely new strategy: Much slower, more realistic progress
        function updateProgress() {
            const now = Date.now();
            const elapsed = now - startTime;
            const timeSinceLastUpdate = now - lastProgressUpdate;
            
            // Only update progress every 3 seconds to make it much slower
            if (timeSinceLastUpdate < 3000) {
                return;
            }
            
            lastProgressUpdate = now;
            
            // Calculate target progress based on elapsed time with much slower progression
            let targetProgress;
            if (elapsed < 30000) { // First 30 seconds: 0-20%
                targetProgress = (elapsed / 30000) * 20;
                progressStage = 0;
            } else if (elapsed < 50000) { // Next 20 seconds: 20-35%
                targetProgress = 20 + ((elapsed - 30000) / 20000) * 15;
                progressStage = 1;
            } else if (elapsed < 70000) { // Next 20 seconds: 35-50%
                targetProgress = 35 + ((elapsed - 50000) / 20000) * 15;
                progressStage = 2;
            } else if (elapsed < 80000) { // Next 10 seconds: 50-65%
                targetProgress = 50 + ((elapsed - 70000) / 10000) * 15;
                progressStage = 3;
            } else if (apiCallStarted && !apiCallCompleted) { // During API call: 65-85%
                targetProgress = 65 + Math.min((elapsed - 80000) / 10000, 1) * 20;
                progressStage = 4;
            } else if (apiCallCompleted) { // After API call: 85-100%
                targetProgress = 85 + Math.min((elapsed - 80000) / 10000, 1) * 15;
                progressStage = 5;
            } else { // Before API call: cap at 65%
                targetProgress = Math.min(65, 50 + ((elapsed - 70000) / 10000) * 15);
                progressStage = 3;
            }
            
            // Smooth progress animation - only move 1% per update maximum
            const progressDiff = targetProgress - currentProgress;
            if (progressDiff > 0) {
                currentProgress += Math.min(progressDiff, 1); // Max 1% per update
            }
            
            // Cap progress based on API state
            if (!apiCallStarted) {
                currentProgress = Math.min(currentProgress, 65);
            } else if (!apiCallCompleted) {
                currentProgress = Math.min(currentProgress, 85);
            }
            
            document.getElementById('progressFill').style.width = currentProgress + '%';
            
            // Update progress text based on current stage
            if (progressStage === 0) {
                document.getElementById('progressText').textContent = 'Initializing analysis...';
            } else if (progressStage === 1) {
                document.getElementById('progressText').textContent = 'Analyzing your responses...';
            } else if (progressStage === 2) {
                document.getElementById('progressText').textContent = 'Processing health data...';
            } else if (progressStage === 3) {
                document.getElementById('progressText').textContent = 'Evaluating risk factors...';
            } else if (progressStage === 4) {
                document.getElementById('progressText').textContent = 'AI is analyzing your health data...';
            } else if (progressStage === 5) {
                document.getElementById('progressText').textContent = 'Processing AI response...';
            } else {
                document.getElementById('progressText').textContent = 'Almost ready...';
            }
        }
        
        function showNextFact() {
            document.getElementById('factContent').textContent = facts[currentFactIndex];
            currentFactIndex = (currentFactIndex + 1) % facts.length;
        }
        
        async function processHealthData() {
            try {
                console.log('Starting health data processing...');
                
                // Mark API call as started
                apiCallStarted = true;
                document.getElementById('progressText').textContent = 'Connecting to AI analysis...';
                
                // Get answers from localStorage
                const answers = JSON.parse(localStorage.getItem('questionnaireData') || '{}');
                console.log('Answers from localStorage:', answers);
                
                // Check if we have cached results
                const cachedResults = localStorage.getItem('cachedResults');
                if (cachedResults) {
                    console.log('Using cached results');
                    localStorage.setItem('healthAssessmentResults', cachedResults);
                    setTimeout(() => {
                        console.log('Redirecting to results.html');
                        window.location.href = 'results.html';
                    }, 2000);
                    return;
                }
                
                // Get user email from localStorage with detailed debugging
                console.log('🔍 DEBUGGING LOCALSTORAGE:');
                console.log('🔍 All localStorage keys:', Object.keys(localStorage));
                console.log('🔍 userEmail value:', localStorage.getItem('userEmail'));
                console.log('🔍 userEmail type:', typeof localStorage.getItem('userEmail'));
                console.log('🔍 userEmail length:', localStorage.getItem('userEmail')?.length);
                
                let userEmail = localStorage.getItem('userEmail');
                console.log('📧 User email for API call:', userEmail);
                
                // If no email found, redirect to email collection page (proper flow)
                if (!userEmail || userEmail === 'null' || userEmail === '') {
                    console.log('📧 No email found, redirecting to email collection page');
                    console.log('📧 Email check failed - userEmail:', userEmail, 'type:', typeof userEmail);
                    window.location.href = 'email-collection.html';
                    return;
                }
                
                console.log('📧 Using existing email from localStorage:', userEmail);
                
                // Make API call to analyze health
                console.log('Making API call with answers:', answers);
                document.getElementById('progressText').textContent = 'AI is analyzing your health data...';
                
                const response = await fetch('https://backend-8p7kgqsn9-annas-projects-3d23b0f3.vercel.app/api/analyze-health', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        responses: answers,
                        userEmail: userEmail 
                    })
                });
                
                document.getElementById('progressText').textContent = 'Processing AI response...';
                
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error('Failed to analyze health data');
                }
                
                const results = await response.json();
                console.log('API results:', results);
                
                // Always use the data field from successful API response
                const healthData = results.data;
                console.log('Health data to save:', healthData);
                console.log('Number of categories:', healthData.categories ? healthData.categories.length : 'No categories');
                
                // Store results in localStorage
                localStorage.setItem('healthAssessmentResults', JSON.stringify(healthData));
                
                // Cache the results
                localStorage.setItem('cachedResults', JSON.stringify(healthData));
                
                // Mark API call as completed
                apiCallCompleted = true;
                
                // Complete the progress bar
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressText').textContent = 'Analysis complete! Redirecting...';
                
                // Redirect to results page
                setTimeout(() => {
                    console.log('Redirecting to results.html');
                    window.location.href = 'results.html';
                }, 2000);
                
            } catch (error) {
                console.log('Error in processHealthData:', error);
                console.log('Error details:', error.message);
                
                // Even if there's an error, try to get fallback data from API response
                let fallbackResults;
                try {
                    const errorResponse = await fetch('https://backend-8p7kgqsn9-annas-projects-3d23b0f3.vercel.app/api/analyze-health', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ responses: answers })
                    });
                    const errorData = await errorResponse.json();
                    if (errorData.fallbackData) {
                        console.log('Using API fallback data with all categories');
                        fallbackResults = errorData.fallbackData;
                    } else {
                        throw new Error('No fallback data from API');
                    }
                } catch (apiError) {
                    console.log('API fallback failed, using minimal fallback');
                    // Minimal fallback with all 6 categories
                    fallbackResults = {
                        assessment_summary: "Based on your health assessment, we have identified key areas for preventive screening. This personalized plan focuses on early detection and prevention to optimize your long-term health and longevity.",
                        urgent_tests: [
                            {
                                name: "HbA1c (3-month average blood sugar)",
                                explanation: "Essential for detecting early diabetes risk years before symptoms appear.",
                                timeframe: "Schedule within 1–2 weeks",
                                status: "RECOMMENDED"
                            },
                            {
                                name: "Lipid Panel (cholesterol, LDL, HDL, triglycerides)",
                                explanation: "Fundamental cardiovascular risk assessment for heart disease prevention.",
                                timeframe: "Schedule within 2 weeks",
                                status: "RECOMMENDED"
                            },
                            {
                                name: "Thyroid Function (TSH, free T4, free T3)",
                                explanation: "Important for metabolic health and energy regulation.",
                                timeframe: "Schedule within 1 month",
                                status: "RECOMMENDED"
                            }
                        ],
                        categories: [
                            {
                                category_name: "Cardiovascular Health",
                                category_description: "Essential tests for heart disease prevention and cardiovascular risk assessment.",
                                tests: [
                                    { name: "Lipid Panel", description: "Measures cholesterol levels and cardiovascular risk factors for heart disease prevention.", status: "MISSING" },
                                    { name: "ApoB", description: "Advanced marker for cardiovascular disease risk assessment and heart attack prevention.", status: "MISSING" },
                                    { name: "hs-CRP", description: "Inflammation marker linked to heart disease risk and cardiovascular health monitoring.", status: "MISSING" },
                                    { name: "Homocysteine", description: "Cardiovascular risk factor and B-vitamin status indicator for heart health.", status: "MISSING" }
                                ]
                            },
                            {
                                category_name: "Metabolic Health",
                                category_description: "Key biomarkers for diabetes prevention and metabolic syndrome detection.",
                                tests: [
                                    { name: "HbA1c", description: "3-month average blood sugar level for diabetes screening and metabolic health monitoring.", status: "MISSING" },
                                    { name: "Fasting Glucose", description: "Current blood sugar level and diabetes risk indicator for metabolic assessment.", status: "MISSING" },
                                    { name: "Fasting Insulin", description: "Insulin resistance marker and metabolic health indicator for diabetes prevention.", status: "MISSING" },
                                    { name: "Liver Enzymes", description: "Liver function and metabolic health assessment for overall metabolic monitoring.", status: "MISSING" }
                                ]
                            },
                            {
                                category_name: "Hormonal Health",
                                category_description: "Comprehensive hormone assessment for optimal endocrine function.",
                                tests: [
                                    { name: "Thyroid Function", description: "Essential for metabolism, energy, and overall health regulation and monitoring.", status: "MISSING" },
                                    { name: "Testosterone (men)", description: "Male hormone levels affecting energy, muscle mass, and vitality for men's health.", status: "MISSING" },
                                    { name: "Cortisol", description: "Stress hormone affecting energy, sleep, and immune function for stress management.", status: "MISSING" },
                                    { name: "DHEA-S", description: "Anti-aging hormone and energy metabolism marker for longevity and vitality.", status: "MISSING" }
                                ]
                            },
                            {
                                category_name: "Nutritional Status",
                                category_description: "Essential vitamins and minerals for optimal health and energy.",
                                tests: [
                                    { name: "Vitamin D", description: "Critical for immune function, bone health, and mood regulation for overall wellness.", status: "MISSING" },
                                    { name: "Vitamin B12 & Folate", description: "Essential for energy production and neurological function for brain and energy health.", status: "MISSING" },
                                    { name: "Ferritin (Iron)", description: "Iron storage levels affecting energy and oxygen transport for vitality and energy.", status: "MISSING" },
                                    { name: "Magnesium & Zinc", description: "Essential minerals for muscle function and immune health for optimal body function.", status: "MISSING" }
                                ]
                            },
                            {
                                category_name: "Longevity Biomarkers",
                                category_description: "Advanced markers for biological aging and longevity optimization.",
                                tests: [
                                    { name: "Biological Aging Marker", description: "Measures cellular aging and biological age vs chronological age for longevity tracking.", status: "MISSING" },
                                    { name: "Omega-3 Index", description: "Essential fatty acid levels for heart and brain health for cognitive and cardiovascular wellness.", status: "MISSING" },
                                    { name: "Genetic Health Screen", description: "Personalized genetic insights for disease prevention and personalized health optimization.", status: "MISSING" }
                                ]
                            },
                            {
                                category_name: "Gut Health",
                                category_description: "Microbiome analysis for digestive health and immune function.",
                                tests: [
                                    { name: "Microbiome Test", description: "Comprehensive analysis of gut bacteria and digestive health for immune and digestive wellness.", status: "MISSING" },
                                    { name: "Stool Analysis", description: "Digestive function and gut health assessment for digestive and immune system monitoring.", status: "MISSING" }
                                ]
                            }
                        ],
                        next_steps: [
                            {
                                timeframe: "URGENT (within 2 weeks)",
                                actions: ["Schedule HbA1c test immediately", "Book Lipid Panel appointment", "Arrange Thyroid Function testing", "Consult with healthcare provider about results"]
                            },
                            {
                                timeframe: "MEDIUM-TERM (within 1 month)",
                                actions: ["Complete metabolic panel (Insulin, Liver enzymes)", "Schedule hormonal assessment", "Address nutritional deficiencies", "Begin targeted supplementation if needed"]
                            },
                            {
                                timeframe: "OPTIONAL (within 3 months)",
                                actions: ["Consider advanced longevity testing", "Explore genetic health screening", "Evaluate microbiome testing options", "Plan follow-up assessments"]
                            }
                        ]
                    };
                }
                
                localStorage.setItem('healthAssessmentResults', JSON.stringify(fallbackResults));
                localStorage.setItem('cachedResults', JSON.stringify(fallbackResults));
                
                // Mark API call as completed
                apiCallCompleted = true;
                
                // Complete the progress bar
                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressText').textContent = 'Analysis complete! Redirecting...';
                
                setTimeout(() => {
                    console.log('Redirecting to results.html with fallback data');
                    window.location.href = 'results.html';
                }, 2000);
            }
        }
        
        // Initialize loading screen
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Loading page initialized');
            
            // Clear any old cached results to ensure fresh data
            localStorage.removeItem('cachedResults');
            console.log('Cleared old cached results for fresh data');
            
            // Reset start time
            startTime = Date.now();
            
            // Start progress animation (much slower updates - every 3 seconds)
            progressInterval = setInterval(updateProgress, 3000);
            
            // Start fact rotation (much slower changes - 12 seconds per fact)
            showNextFact();
            factInterval = setInterval(showNextFact, 12000);
            
            // Start health data processing after a much longer delay to let progress build up
            setTimeout(processHealthData, 15000);
        });
        
        // Cleanup intervals when page unloads
        window.addEventListener('beforeunload', function() {
            if (progressInterval) clearInterval(progressInterval);
            if (factInterval) clearInterval(factInterval);
        });
    </script>
</body>
</html>
